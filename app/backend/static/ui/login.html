<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Created with ❤️ by FLECS" />
  <title>FLECS - Login</title>
  <link rel="icon" type="image/x-icon" href="images/favicon.ico" />
  <link rel="stylesheet" href="css/main.css" />
</head>
<body>
  <main class="card">
    <div class="header">
      <img src="images/logo.svg" alt="FLECS Logo" class="logo" />
      <h1>Please sign in to continue</h1>
    </div>
    <form id="loginForm" autocomplete="on" spellcheck="false">
      <div class="row">
        <label for="username">Username</label>
        <input id="username" name="username" type="text" required autocomplete="username" autocapitalize="none" />
      </div>
      <div class="row">
        <label for="password">Password</label>
        <input id="password" name="password" type="password" required autocomplete="current-password" />
      </div>
      <button id="loginBtn" type="submit">Login</button>
      <div id="status" role="status" aria-live="polite"></div>
    </form>
    <noscript><p class="note">JavaScript is required to submit as JSON.</p></noscript>
  </main>

  <script>
    (function () {
      const form = document.getElementById('loginForm');
      const btn = document.getElementById('loginBtn');
      const statusEl = document.getElementById('status');

      function showStatus(kind, msg, isHtml = false) {
        statusEl.className = '';
        statusEl.classList.add(kind === 'ok' ? 'ok' : 'err');
        if (isHtml) {
          statusEl.innerHTML = msg;
        } else {
          statusEl.textContent = msg;
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = form.username.value.trim();
        const password = form.password.value;

        if (!username || !password) {
          showStatus('err', 'Please enter both username and password.');
          return;
        }

        btn.disabled = true;
        showStatus('ok', 'Signing in...');
        try {
          const res = await fetch('/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            credentials: 'include', // send/receive cookies if your server uses them
            body: JSON.stringify({ username, password })
          });

          const contentType = res.headers.get('content-type') || '';
          let payload;
          if (contentType.includes('application/json')) {
            payload = await res.json();
          } else {
            payload = await res.text();
          }

          if (res.ok) {
            showStatus('ok', typeof payload === 'string' ? payload : (payload.message || 'Login successful.'));
          } else {
            // Render HTML error responses directly
            if (typeof payload === 'string' && payload.includes('<html>')) {
              showStatus('err', payload, true); // Pass true to render as HTML
            } else {
              showStatus('err', payload.error || payload.message || 'Login failed. Please try again.');
            }
          }
        } catch (err) {
          showStatus('err', 'Network error. Please try again.');
          console.error(err);
        } finally {
          btn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>